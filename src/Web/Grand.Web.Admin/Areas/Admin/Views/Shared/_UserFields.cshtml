@model Grand.Infrastructure.Models.BaseEntityModel
@inject Grand.Business.Common.Interfaces.Stores.IStoreService storeService
@inject Grand.Business.Common.Interfaces.Security.IPermissionService permissionService
@{
    var userFields = Model.UserFields.ToList();
    var stores = (await storeService.GetAllStores()).Select(store => new SelectListItem
    {
        Text = store.Shortcut,
        Value = store.Id,
    }).ToList();
    var permission = await permissionService.Authorize(Grand.Business.Common.Services.Security.PermissionSystemName.UserFields);
}
@if (!string.IsNullOrEmpty(Model.Id))
{
    <vc:admin-widget widget-zone="userfield_details_info_top" additional-data="Model" />
    <div class="panel panel-default">
        <div class="form-horizontal form-userfield" id="form-userfield">
            @for (int item = 0; item < userFields.Count; item++)
            {
                <div class="form-body">
                    <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3">@userFields[item].Key</label>
                        <div class="col-md-6 col-sm-6">
                            <admin-input asp-for="@userFields[item].Value" />
                            <input type="hidden" asp-for="@userFields[item].Key" />
                        </div>
                        <div class="col-md-3 col-sm-3 input-group custom-input-group">
                            <admin-select asp-for="@userFields[item].StoreId" asp-items="@stores" />
                            <span class="input-group-addon btn red" onclick="gadelete('@userFields[item].Key', '@userFields[item].StoreId')"><i class="fa fa fa-times"></i></span>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <script id="template" type="text/html">
        <div class="form-body">
            <div class="form-group">
                <label class="control-label col-md-3 col-sm-3">${key}</label>
                <div class="col-md-6 col-sm-6">
                    <input class="form-control k-input text-box single-line valid"
                           id="UserFields_${id}__Value" name="UserFields[${id}].Value" type="text" value="${value}">
                    <input type="hidden" id="UserFields_${id}__Key" name="UserFields[${id}].Key" value="${key}">
                </div>
                <div class="col-md-3 col-sm-3 input-group custom-input-group">
                    <select id="UserFields_{id}__StoreId" name="UserFields[${id}].StoreId" class="form-control k-input valid">
                        @foreach (var store in stores)
                        {
                            <option value="@store.Value">@store.Text</option>
                        }
                    </select>
                    <span class="input-group-addon btn red" onclick="gadelete('${key}')"><i class="fa fa fa-times"></i></span>
                </div>
            </div>
        </div>

    </script>


    <script>
            function gadelete(key, store) {
                if (confirm('@Loc["Admin.Common.AreYouSure"]')) {
                    var postData = {
                        Key: key,
                        StoreId: store,
                        Value: 'empty',
                        ObjectType: "@ViewData["ObjectType"]",
                        SelectedTab: '@ViewData["TabIndex"]',
                        Id: '@Model.Id',
                    };
                    addAntiForgeryToken(postData);
                    $.ajax({
                        cache: false,
                        type: "POST",
                        url: "@(Url.Action("Delete", "UserField", new { area = Constants.AreaAdmin }))",
                        data: postData,
                        success: function (data) {
                            if (data.success) {
                                window.location.href = window.location.href;
                            }
                            else
                                alert(data.errors);
                        },
                        error: function (xhr, ajaxOptions, thrownError) {
                            alert('Failed to add.');
                        }
                    });
                }
            };
    </script>
    @if (permission)
    {
        <div class="panel panel-default">
            <div class="panel-body">
                <p>
                    <strong>@Loc["Admin.Common.UserFields.AddNew"]</strong>
                </p>
                <div class="form-horizontal">
                    <div class="form-body">
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3">@Loc["Admin.Common.UserFields.Fields.Key"]</label>
                            <div class="col-md-9 col-sm-9">
                                <input class="form-control k-input text-box single-line valid" id="ga_key" name="ga_key" type="text" value="">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3">@Loc["Admin.Common.UserFields.Fields.Value"]</label>
                            <div class="col-md-9 col-sm-9">
                                <input class="form-control k-input text-box single-line valid" id="ga_value" name="ga_value" type="text" value="">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel-footer">
                <button type="button" id="addUserField" class="k-primary k-button"><i class="fa fa-plus"></i>@Loc["Admin.Common.UserFields.AddNew.Button"]</button>
            </div>
        </div>
        <script>
            $(document).ready(function () {
                var counter = @userFields.Count;
                $('#addUserField').click(function () {
                    var attrKey = $("#ga_key").val();
                    var attrValue = $("#ga_value").val();

                    //some validation
                    if (attrKey === "") {
                        alert('@Loc["Admin.Common.UserFields.Fields.Key.Required"]');
                        return;
                    }
                    if (attrValue === "") {
                        alert('@Loc["Admin.Common.UserFields.Fields.Value.Required"]');
                        return;
                    }
                    var data = { key: attrKey, value: attrValue, id: counter };
                    $("#template").tmpl(data).appendTo("#form-userfield");
                    counter = counter + 1;
                });
            });
        </script>
        <vc:admin-widget widget-zone="userfield_details_info_bottom" additional-data="Model" />
    }
}
else
{
    <vc:admin-widget widget-zone="userfield_details_info_savebefore" additional-data="Model" />
    <div class="note note-info">
        @Loc["Admin.Common.UserFields.SaveBeforeEdit"]
    </div>
}
